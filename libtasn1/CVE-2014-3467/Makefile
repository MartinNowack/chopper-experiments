ROOT=$(realpath ../..)
include $(ROOT)/common.mk

.SILENT:

SRC_PATH=./libtasn1-3.5/

INCLUDES=-I $(KLEE_SRC_DIR)/include -I $(SRC_PATH) -I $(SRC_PATH)/lib -I $(SRC_PATH)/lib/gllib
DEFINES=-D_GNU_SOURCE -DSIZEOF_UNSIGNED_INT=4 -DSIZEOF_UNSIGNED_LONG_INT=8

CFLAGS=-emit-llvm -c -g $(DEFINES) $(INCLUDES)
LDFLAGS=

%.bc: %.c
	$(CLANG) $(CFLAGS) $< -o $@

SOURCES=$(shell ls $(SRC_PATH)/lib/*.c) $(shell ls $(SRC_PATH)/lib/gllib/hash-pjw-bare.c) main.c
DEPS=$(patsubst %.c,%.o,$(SOURCES))
BC_DEPS=$(patsubst %.c,%.bc,$(SOURCES))

TARGET=test.bc

all: $(TARGET)

$(TARGET): $(BC_DEPS)
	$(LINK) $^ -o $@
	$(OPT) -mem2reg $@ -o $@
	$(DIS) $@

all-experiments: all-klee all-cse

all-klee: run-klee-random run-klee-dfs run-klee-coverage

run-klee-random: $(TARGET)
	echo "** Running KLEE with random search"
	-$(KLEE) \
	--exit-on-error-type=Ptr \
	--libc=uclibc --posix-runtime \
	--search=random-state \
	--output-dir=klee-run-random \
	--no-output \
	test.bc 32 > run-klee-random.log 2>&1
run-klee-dfs: $(TARGET)
	echo "** Running KLEE with dfs search"
	-$(KLEE) \
	--exit-on-error-type=Ptr \
	--libc=uclibc --posix-runtime \
	--search=dfs \
	--output-dir=klee-run-df \
	--no-output \
	test.bc 32 > run-klee-dfs.log 2>&1
run-klee-coverage: $(TARGET)
	echo "** Running KLEE with coverage search"
	-$(KLEE) \
	--exit-on-error-type=Ptr \
	--libc=uclibc --posix-runtime \
	--search=nurs:covnew \
	--output-dir=klee-run-coverage \
	--no-output \
	test.bc 32 > run-klee-coverage.log 2>&1

all-cse: run-cse-random-1 run-cse-dfs-1 run-cse-coverage-1 run-cse-random-2 run-cse-dfs-2 run-cse-coverage-2 run-cse-random-3 run-cse-dfs-3 run-cse-coverage-3

run-cse-random-1: $(TARGET)
	echo "** Running CHASER with random search"
	-$(KLEE) \
	--exit-on-error-type=Ptr --error-location=decoding.c:152 \
	--libc=uclibc \
	$(KSLICE) --search=random-state \
	--skip-functions=_asn1_get_octet_string:1092,asn1_delete_structure:1374 \
	--output-dir=cse-run-random \
	--no-output \
	test.bc 32 > run-cse-random.log 2>&1
run-cse-dfs-1: $(TARGET)
	echo "** Running CHASER with dfs search"
	-$(KLEE) \
	--exit-on-error-type=Ptr --error-location=decoding.c:152 \
	--libc=uclibc \
	$(KSLICE) --search=dfs \
	--skip-functions=_asn1_get_octet_string:1092,asn1_delete_structure:1374 \
	--output-dir=cse-run-dfs \
	--no-output \
	test.bc 32 > run-cse-dfs.log 2>&1
run-cse-coverage-1: $(TARGET)
	echo "** Running CHASER with coverage search"
	-$(KLEE) \
	--exit-on-error-type=Ptr --error-location=decoding.c:152 \
	--libc=uclibc \
	$(KSLICE) --search=nurs:covnew \
	--skip-functions=_asn1_get_octet_string:1092,asn1_delete_structure:1374 \
	--output-dir=cse-run-coverage \
	--no-output \
	test.bc 32 > run-cse-coverage.log 2>&1

run-cse-random-2: $(TARGET)
	echo "** Running CHASER with random search"
	-$(KLEE) \
	--exit-on-error-type=Ptr --error-location=decoding.c:709 \
	--libc=uclibc \
	$(KSLICE) --search=random-state \
	--skip-functions=_asn1_get_octet_string:1092,asn1_delete_structure:1374 \
	--output-dir=cse-run-random \
	--no-output \
	test.bc 32 > run-cse-random.log 2>&1
run-cse-dfs-2: $(TARGET)
	echo "** Running CHASER with dfs search"
	-$(KLEE) \
	--exit-on-error-type=Ptr --error-location=decoding.c:709 \
	--libc=uclibc \
	$(KSLICE) --search=dfs \
	--skip-functions=_asn1_get_octet_string:1092,asn1_delete_structure:1374 \
	--output-dir=cse-run-dfs \
	--no-output \
	test.bc 32 > run-cse-dfs.log 2>&1
run-cse-coverage-2: $(TARGET)
	echo "** Running CHASER with coverage search"
	-$(KLEE) \
	--exit-on-error-type=Ptr --error-location=decoding.c:709 \
	--libc=uclibc \
	$(KSLICE) --search=nurs:covnew \
	--skip-functions=_asn1_get_octet_string:1092,asn1_delete_structure:1374 \
	--output-dir=cse-run-coverage \
	--no-output \
	test.bc 32 > run-cse-coverage.log 2>&1

run-cse-random-3: $(TARGET)
	echo "** Running CHASER with random search"
	-$(KLEE) \
	--exit-on-error-type=Ptr --error-location=decoding.c:1131 \
	--libc=uclibc \
	$(KSLICE) --search=random-state \
	--skip-functions=_asn1_get_octet_string:1092,asn1_delete_structure:1374 \
	--output-dir=cse-run-random \
	--no-output \
	test.bc 32 > run-cse-random.log 2>&1
run-cse-dfs-3: $(TARGET)
	echo "** Running CHASER with dfs search"
	-$(KLEE) \
	--exit-on-error-type=Ptr --error-location=decoding.c:1131 \
	--libc=uclibc \
	$(KSLICE) --search=dfs \
	--skip-functions=_asn1_get_octet_string:1092,asn1_delete_structure:1374 \
	--output-dir=cse-run-dfs \
	--no-output \
	test.bc 32 > run-cse-dfs.log 2>&1
run-cse-coverage-3: $(TARGET)
	echo "** Running CHASER with coverage search"
	-$(KLEE) \
	--exit-on-error-type=Ptr --error-location=decoding.c:1131 \
	--libc=uclibc \
	$(KSLICE) --search=nurs:covnew \
	--skip-functions=_asn1_get_octet_string:1092,asn1_delete_structure:1374 \
	--output-dir=cse-run-coverage \
	--no-output \
	test.bc 32 > run-cse-coverage.log 2>&1

clean:
	rm -rf $(DEPS) $(BC_DEPS) $(TARGET)
	rm -f test.*
	rm -rf klee-*
