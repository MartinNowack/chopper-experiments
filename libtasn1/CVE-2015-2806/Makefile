KLEE_PATH=~/tau/klee/klee/
SRC_PATH=./libtasn1-4.3/

INCLUDES=-I $(KLEE_PATH)/include -I $(SRC_PATH) -I $(SRC_PATH)/lib -I $(SRC_PATH)/lib/gllib
DEFINES=-D_GNU_SOURCE -DSIZEOF_UNSIGNED_INT=4 -DSIZEOF_UNSIGNED_LONG_INT=8

CFLAGS=-emit-llvm -c -g $(DEFINES) $(INCLUDES)
LDFLAGS=
CC=gcc
#CLANG=clang-3.4
CLANG=clang
#LINK=llvm-link-3.4
LINK=llvm-link
OPT=opt
LLVM_DIS=llvm-dis

%.o: %.c
	$(CC) $(CFLAGS) $< -o $@

%.bc: %.c
	$(CLANG) $(CFLAGS) $< -o $@

SOURCES=$(shell ls $(SRC_PATH)/lib/*.c) $(shell ls $(SRC_PATH)/lib/gllib/hash-pjw-bare.c) main.c
DEPS=$(patsubst %.c,%.o,$(SOURCES))
BC_DEPS=$(patsubst %.c,%.bc,$(SOURCES))

all: test.bc

test.bc: $(BC_DEPS)
	$(LINK) $^ -o $@
	$(OPT) -mem2reg $@ -o $@
	$(LLVM_DIS) $@

test: $(DEPS)
	$(CC) $^ -o $@ $(LDFLAGS) 

clean:
	rm -rf $(DEPS) $(BC_DEPS)

run: test.bc
	klee -max-time=180 -libc=uclibc --posix-runtime $<
